<html>
<head>
<style>
	#roundPicksDiv
	{
		position: absolute;
		top: 0px;
	}
</style>
<script language="javascript">
var config = null;
var bracket = null;
var loginInfo = null;
var getLoginInfo = new XMLHttpRequest();
var postLoginInfo = new XMLHttpRequest();
var getBracketInfo = new XMLHttpRequest();
var postPicksInfo = new XMLHttpRequest();

var load = function()
{
	gebi("roundPicksDiv").style.visibility = "hidden";
	getLoginInfo.open("GET", "/logininfo/all/" + Math.floor(10000*Math.random()));
	getLoginInfo.send();
}

getLoginInfo.onreadystatechange = function()
{
	if (this.readyState == 4 && this.status == 200)
	{
		var playerNames = JSON.parse(this.responseText);
		for(var i=0; i < playerNames.length; i++)
		{
			gebi("usernamesSelect").add(new Option(playerNames[i], playerNames[i]));
		}
	}
}

var login = function()
{
	loginInfo = new Object();
	loginInfo.username = gebi("usernamesSelect").value;
	loginInfo.password = gebi("passwordText").value;
	postLoginInfo.open("POST", "/logininfo/all/info");
	postLoginInfo.send(JSON.stringify(loginInfo, null, 2));
	console.log(JSON.stringify(loginInfo, null, 2));
}

postLoginInfo.onreadystatechange = function()
{
	if (this.readyState == 4 && this.status == 200)
	{
		config = JSON.parse(this.responseText);
		console.log(JSON.stringify(config, null, 2));
		if (config.error == 0)
		{
			gebi("loginDiv").style.visibility = "hidden";
			console.log("Login Successful");
			getBracketInfo.open("GET", "/bracketinfo/all/" + + Math.floor(10000*Math.random()));
			getBracketInfo.send();
		}
		else
		{
			alert("Wrong password");
		}
	}
}

getBracketInfo.onreadystatechange = function()
{
	if (this.readyState == 4 && this.status == 200)
	{
		console.log("Received Bracket info");
		bracket = JSON.parse(this.responseText);
		if (config.pickPeriod == "true")
		{
			var roundDiv = gebi("roundPicksDiv");
			var round = bracket["round" + config.round];
			roundDiv.style.visibility = "visible";
			var t = document.createElement("table");
			var r = t.insertRow(-1)
			var c = r.insertCell(-1);
			c.textContent = "Matchup";
			c = r.insertCell(-1);
			c.textContent = "Choix / Choice";
			c = r.insertCell(-1);
			c.textContent = "# of Games";
			c = r.insertCell(-1);
			c.textContent = "Poids / Weight";
			for(var i=0 ; i < round.matchups.length; i++)
			{
				r = t.insertRow(-1)
				c = r.insertCell(-1);
				c.textContent = "Matchup #" + (i+1) + " : " + round.matchups[i].team1 + " vs. " + round.matchups[i].team2;
				c = r.insertCell(-1)
				var s = document.createElement("select");
				s.id = "winner-" + config.round + "-" + i;
				s.add(new Option("", ""));
				s.add(new Option(round.matchups[i].team1, round.matchups[i].team1));
				s.add(new Option(round.matchups[i].team2, round.matchups[i].team2));
				c.appendChild(s);
				c = r.insertCell(-1);
				c.appendChild(createNumberOfGamesSelect("numberOfGames-" + config.round + "-" + i));
				c = r.insertCell(-1);
				c.appendChild(createWeigthSelect("weigthOfGame-" + config.round + "-" + i, round.matchups.length));
				
			}
			
			if (config.round == 1)
			{
				r = t.insertRow(-1);
				c = r.insertCell(-1);
				c.textContent = "Finaliste Est / Eastern Finalist";
				c = r.insertCell(-1);
				var s = document.createElement("select");
				s.add(new Option("", ""));
				s.id = "easternFinalist";
				for(var i=0; i < 4; i++)
				{
					s.add(new Option(round.matchups[i].team1, round.matchups[i].team1));
					s.add(new Option(round.matchups[i].team2, round.matchups[i].team2));
				}
				c.appendChild(s);
				c = r.insertCell(-1);
				c.textContent = "5 pts";
				r = t.insertRow(-1);
				c = r.insertCell(-1);
				c.textContent = "Finaliste Ouest / Western Finalist";
				c = r.insertCell(-1);
				s = document.createElement("select");
				s.add(new Option("", ""));
				s.id = "westernFinalist";
				for(var i=4; i < 8; i++)
				{
					s.add(new Option(round.matchups[i].team1, round.matchups[i].team1));
					s.add(new Option(round.matchups[i].team2, round.matchups[i].team2));
				}
				c.appendChild(s);
				c = r.insertCell(-1);
				c.textContent = "5 pts";
				r = t.insertRow(-1);
				c = r.insertCell(-1);
				c.textContent = "Gagnant de la coupe / Cup Winner";
				c = r.insertCell(-1);
				s = document.createElement("select");
				s.id = "cupWinner";
				s.add(new Option("", ""));
				for(var i=0; i < 8; i++)
				{
					s.add(new Option(round.matchups[i].team1, round.matchups[i].team1));
					s.add(new Option(round.matchups[i].team2, round.matchups[i].team2));
				}
				c.appendChild(s);
				c = r.insertCell(-1);
				c.textContent = "10 pts";
			}
			r = t.insertRow(-1);
			c = r.insertCell(-1);
			c.colSpan = 3;
			var b = document.createElement("input");
			b.type = "button";
			b.addEventListener("click", submitPicks);
			b.value = "Submit Picks";
			c.appendChild(b);
			
			roundDiv.appendChild(t);
			
		}
		calculateResults();
		//gebi("resultsDiv").style.visibility = "visible";
	}
}

var submitPicks = function(e)
{
	var round = bracket["round" + config.round];
	console.log("Submitting Picks to Server");
	var picks = new Object();
	picks.username = loginInfo.username;
	picks.password = loginInfo.password;
	picks["round" + config.round] = new Object();
	picks["round" + config.round].matchups = new Array();
	for(var i = 0; i < round.matchups.length; i++)
	{
		var pick = new Object();
		pick.winner = gebi("winner-" + config.round + "-" + i).value;
		pick.numberOfGames = gebi("numberOfGames-" + config.round + "-" + i).value;
		pick.weigthOfGame = gebi("weigthOfGame-" + config.round + "-" + i).value;
		picks["round" + config.round].matchups.push(pick);
		
	}
	if (config.round == 1)
	{
		picks["round" + config.round].easternFinalist = gebi("easternFinalist").value;
		picks["round" + config.round].westernFinalist = gebi("westernFinalist").value;
		picks["round" + config.round].cupWinner = gebi("cupWinner").value;
	}
	if (validatePicks(picks) == true)
	{
		console.log(JSON.stringify(picks, null,2));
		postPicksInfo.open("POST", "/picksinfo/all/null");
		postPicksInfo.send(JSON.stringify(picks, null, 2));
	}
	else
	{
		console.log("Invalid Picks :\n");
		alert("Invalid Picks :\n" + validatePicks(picks));
	}
}

postPicksInfo.onreadystatechange = function()
{
	if (this.readyState == 4 && this.status == 200)
	{
		console.log(this.responseText);
		gebi("roundPicksDiv").innerHTML = "";
		gebi("roundPicksDiv").innerHTML ="<textarea cols='60' rows='40'>" +  this.responseText + "</textarea>";
	}

}

var validatePicks = function(p)
{
	var ret = true;
	var map = new Array();
	var m = p["round" + config.round].matchups;
	for(var i = 0; i < m.length; i++)
	{
		if(m[i].winner == "")
		{
			ret = "Empty winner at " + (i+1);
			console.log("Empty winner at " + (i+1));
		}
		if(m[i].numberOfGames == "" || m[i].numberOfGames == undefined)
		{
			ret = "Empty number of games at " + (i+1);
			console.log("Empty number of games at " + (i+1));
		}
		
		
		if(m[i].weigthOfGame == "" || m[i].weigthOfGame == undefined)
		{
			ret = "Empty weigth of games at " + (i+1);
			console.log("Empty weigth of games at " + (i+1));
		}
		else if (map[m[i].weigthOfGame] != undefined)
		{
			ret = "Dupplicate weigth of games at " + (i+1);
			console.log("Dupplicate weigth of games at " + (i+1));
		}
		else
		{
			map[m[i].weigthOfGame] = true;
		}
	}
	
	if (config.round == 1 )
	{
		if (p["round1"].easternFinalist == undefined || 
		    p["round1"].westernFinalist == undefined || 
			p["round1"].cupWinner == undefined ||
			p["round1"].easternFinalist == "" || 
		    p["round1"].westernFinalist == "" || 
			p["round1"].cupWinner == ""
		   )
		{
			console.log("Missing finalist of cup winner");
			ret = "Missing finalist of cup winner";
		}
	}
	
	return ret;
}


var createWeigthSelect = function(id, length)
{
	var ret = document.createElement("select");
	ret.id = id;
	ret.add(new Option("", ""));
	for(var i = 8-length+1; i <= 8; i++)
	{
		ret.add(new Option(i + " pts",i));
	}
	return ret;
}

var createNumberOfGamesSelect = function(id)
{
	var ret = document.createElement("select");
	ret.id = id;
	ret.add(new Option("", ""));
	for(var i = 4; i <= 8; i++)
	{
		ret.add(new Option(i + " games",i));
	}
	return ret;
}


var calculateResults = function()
{
}

var gebi = function(id)
{
	return document.getElementById(id);
}
</script>
</head>
<body onload="load();">
<div id="loginDiv">
	<h1>LOGIN</h1>
	<select id="usernamesSelect"></select><br/>
	<input type="text" id="passwordText" type="password" />
	<input type="button" value="LOGIN" onclick="login();" />
</div>
<div id="roundPicksDiv">
	<h1>Round 1 Picks</h1>
</div>

</body>
</html>
